generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  STAFF
  PARENT
  TEEN
}

enum RegistrationStatus {
  PENDING_PARENT_VERIFICATION
  PENDING_ADDITIONAL_INFO
  COMPLETE
}

enum FormStatus {
  ACTIVE
  ARCHIVED
}

enum FormFieldType {
  SECTION
  SHORT_TEXT
  LONG_TEXT
  NUMBER
  DATE
  EMAIL
  PHONE
  CHECKBOX
  SELECT
  MULTI_SELECT
  SIGNATURE
}

enum FormValidityUnit {
  DAYS
  MONTHS
  YEARS
}

enum FormCategory {
  GENERAL
  RELEASE
  EVENT
  MEDICAL
}

model User {
  id           String    @id @default(cuid())
  role         Role      @default(ADMIN)
  email        String?   @unique
  username     String?   @unique
  passwordHash String
  permissionsJson Json?
  firstName    String?
  lastName     String?
  displayName  String?
  phone        String?
  title        String?
  bio          String?
  archivedAt   DateTime?
  archivedReason String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  auditLogs    AuditLog[]
  sessions     Session[]
  accounts     Account[]
  formsCreated Form[] @relation("FormCreator")
  formAssignments FormAssignment[] @relation("FormAssigner")
  formSubmissions FormSubmission[] @relation("FormSubmitter")
}

model Teen {
  id                       String             @id @default(cuid())
  publicId                 String?            @unique
  firstName                String
  lastName                 String
  dob                      DateTime
  email                    String?
  phone                    String?
  addressLine1             String?
  addressLine2             String?
  city                     String?
  state                    String?
  postalCode               String?
  parish                   String?
  emergencyContactName     String?
  emergencyContactPhone    String?
  parentName               String?
  parentEmail              String?
  parentPhone              String?
  parentRelationship       String?
  registrationStatus       RegistrationStatus @default(PENDING_PARENT_VERIFICATION)
  registrationSchemaVersion Int               @default(1)
  registrationDataJson     Json?
  archivedAt               DateTime?
  archivedReason           String?
  createdAt                DateTime           @default(now())
  updatedAt                DateTime           @updatedAt
  attendanceRecords        AttendanceRecord[]
  formAssignments          FormAssignment[]
  formSubmissions          FormSubmission[]
}

model AttendanceRecord {
  id         String   @id @default(cuid())
  teen       Teen     @relation(fields: [teenId], references: [id])
  teenId     String
  checkInAt  DateTime
  checkOutAt DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([teenId, checkInAt])
}

model Form {
  id           String      @id @default(cuid())
  name         String
  description  String?
  status       FormStatus  @default(ACTIVE)
  category     FormCategory @default(GENERAL)
  validForValue Int?
  validForUnit FormValidityUnit?
  validUntil   DateTime?
  createdById  String?
  createdBy    User?       @relation("FormCreator", fields: [createdById], references: [id])
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  fields       FormField[]
  assignments  FormAssignment[]
  submissions  FormSubmission[]
}

model FormField {
  id         String         @id @default(cuid())
  formId     String
  form       Form           @relation(fields: [formId], references: [id])
  type       FormFieldType
  label      String
  helpText   String?
  required   Boolean        @default(false)
  optionsJson Json?
  order      Int            @default(0)
  archivedAt DateTime?
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  @@index([formId, order])
}

model FormAssignment {
  id           String       @id @default(cuid())
  formId       String
  form         Form         @relation(fields: [formId], references: [id])
  teenId       String
  teen         Teen         @relation(fields: [teenId], references: [id])
  assignedById String?
  assignedBy   User?        @relation("FormAssigner", fields: [assignedById], references: [id])
  dueAt        DateTime?
  required     Boolean      @default(true)
  archivedAt   DateTime?
  completedAt  DateTime?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  submissions  FormSubmission[]

  @@index([teenId, formId])
  @@index([archivedAt])
}

model FormSubmission {
  id           String       @id @default(cuid())
  formId       String
  form         Form         @relation(fields: [formId], references: [id])
  teenId       String
  teen         Teen         @relation(fields: [teenId], references: [id])
  assignmentId String?
  assignment   FormAssignment? @relation(fields: [assignmentId], references: [id])
  submittedById String?
  submittedBy  User?        @relation("FormSubmitter", fields: [submittedById], references: [id])
  dataJson     Json
  parentSignatureJson Json?
  submittedAt  DateTime     @default(now())
  expiresAt    DateTime?
  updatedAt    DateTime     @updatedAt

  @@index([teenId, formId])
  @@index([assignmentId])
}

model AuditLog {
  id         String   @id @default(cuid())
  user       User?    @relation(fields: [userId], references: [id])
  userId     String?
  action     String
  entityType String
  entityId   String
  beforeJson Json?
  afterJson  Json?
  createdAt  DateTime @default(now())
}

// NextAuth adapter tables
model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?
  access_token       String?
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?
  session_state      String?
  oauth_token_secret String?
  oauth_token        String?
  user               User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
