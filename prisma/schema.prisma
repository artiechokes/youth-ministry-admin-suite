generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  STAFF
  PARENT
  TEEN
}

enum RegistrationStatus {
  PENDING_PARENT_VERIFICATION
  PENDING_ADDITIONAL_INFO
  COMPLETE
}

model User {
  id           String    @id @default(cuid())
  role         Role      @default(ADMIN)
  email        String?   @unique
  username     String?   @unique
  passwordHash String
  permissionsJson Json?
  firstName    String?
  lastName     String?
  displayName  String?
  phone        String?
  title        String?
  bio          String?
  archivedAt   DateTime?
  archivedReason String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  auditLogs    AuditLog[]
  sessions     Session[]
  accounts     Account[]
}

model Teen {
  id                       String             @id @default(cuid())
  firstName                String
  lastName                 String
  dob                      DateTime
  email                    String?
  phone                    String?
  addressLine1             String?
  addressLine2             String?
  city                     String?
  state                    String?
  postalCode               String?
  parish                   String?
  emergencyContactName     String?
  emergencyContactPhone    String?
  parentName               String?
  parentEmail              String?
  parentPhone              String?
  parentRelationship       String?
  registrationStatus       RegistrationStatus @default(PENDING_PARENT_VERIFICATION)
  registrationSchemaVersion Int               @default(1)
  registrationDataJson     Json?
  archivedAt               DateTime?
  archivedReason           String?
  createdAt                DateTime           @default(now())
  updatedAt                DateTime           @updatedAt
  attendanceRecords        AttendanceRecord[]
}

model AttendanceRecord {
  id         String   @id @default(cuid())
  teen       Teen     @relation(fields: [teenId], references: [id])
  teenId     String
  checkInAt  DateTime
  checkOutAt DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([teenId, checkInAt])
}

model AuditLog {
  id         String   @id @default(cuid())
  user       User?    @relation(fields: [userId], references: [id])
  userId     String?
  action     String
  entityType String
  entityId   String
  beforeJson Json?
  afterJson  Json?
  createdAt  DateTime @default(now())
}

// NextAuth adapter tables
model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?
  access_token       String?
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?
  session_state      String?
  oauth_token_secret String?
  oauth_token        String?
  user               User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
